---
- name: pfSense configuration
  hosts: routers
  gather_facts: no
  become: yes
  tasks:
    - name: Check if ntopng is already installed
      shell: pkg info ntopng
      register: ntopng_check
      failed_when: false
      changed_when: false

    - name: Install ntopng if not present
      shell: pkg install -y pfSense-pkg-ntopng
      when: "'ntopng' not in ntopng_check.stdout"

    - name: Copy files to pfSense
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "{{ item.mode }}"
      with_items: "{{ files }}"

    - name: Reboot pfSense
      shell: /sbin/reboot
      async: 1
      poll: 0
      ignore_errors: true

    - name: End play gracefully after reboot
      meta: end_play
